#!/bin/bash
set -e

# Add libraries to ldconfig
echo "/usr/local/lib" > /etc/ld.so.conf.d/amd-vrt.conf
ldconfig

# Build and install PCIe hotplug driver
if [ -d "/usr/src/pcie-hotplug-drv" ]; then
    echo "Building PCIe hotplug driver..."
    cd /usr/src/pcie-hotplug-drv
    make clean
    make
    
    # Install the driver
    make install
    
    # Add the module to modules-load.d to ensure it loads at boot
    echo "Configuring pcie_hotplug module to load at boot..."
    echo "pcie_hotplug" > /etc/modules-load.d/amd-vrt.conf
    
    # Create comprehensive udev rules first
    echo "Creating VRT device permission rules..."
    cat > /etc/udev/rules.d/99-amd-vrt-permissions.rules << 'EOF'
# For PCIe hotplug devices - match on both the specific name and wildcard
KERNEL=="pcie_hotplug", MODE="0666", GROUP="users"
KERNEL=="pcie_hotplug*", MODE="0666", GROUP="users"
EOF
    
    # Reload rules before loading the module
    udevadm control --reload-rules
    
    # Create a persistent device setup script that also loads the module if needed
    cat > /usr/local/bin/vrt-setup-devices.sh << 'EOF'
#!/bin/bash
# This script ensures VRT devices have proper permissions and the module is loaded
# It runs both at boot time and can be run manually after module reloading

# Check if module is loaded, if not, load it
if ! lsmod | grep -q "pcie_hotplug"; then
    echo "Loading pcie_hotplug module..."
    modprobe pcie_hotplug || echo "Warning: Failed to load pcie_hotplug module"
    # Give udev time to create device nodes
    sleep 1
fi

# Set permissions for all VRT-related devices
for dev in /dev/pcie_hotplug*; do
  if [ -e "$dev" ]; then
    chmod 666 "$dev" || echo "Warning: Failed to set permissions for $dev"
    chown root:users "$dev" || echo "Warning: Failed to change owner for $dev"
    echo "Set permissions for $dev"
  fi
done
EOF
    
    chmod +x /usr/local/bin/vrt-setup-devices.sh
    
    # Create systemd service to run at boot
    cat > /etc/systemd/system/vrt-devices.service << 'EOF'
[Unit]
Description=VRT Device Permissions
After=systemd-udev-settle.service
After=systemd-modules-load.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/vrt-setup-devices.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF
    
    # Enable the service for future boots
    systemctl daemon-reload
    systemctl enable vrt-devices.service
    
    # Now load the module
    if lsmod | grep -q "pcie_hotplug"; then
        echo "Reloading pcie_hotplug module..."
        rmmod pcie_hotplug || echo "Warning: Failed to unload pcie_hotplug module"
        modprobe pcie_hotplug || echo "Warning: Failed to load pcie_hotplug module"
    else
        echo "Loading pcie_hotplug module..."
        modprobe pcie_hotplug || echo "Warning: Failed to load pcie_hotplug module"
    fi
    
    # Apply permissions immediately after module loading
    udevadm trigger
    sleep 1  # Give udev a moment to create the device nodes
    /usr/local/bin/vrt-setup-devices.sh
fi

exit 0
